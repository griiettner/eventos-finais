---
id: "dbbfc21c-392e-4cf7-9789-ba55e9eec7d0"
title: "Backend API Server Implementation"
type: "concept"
tags: ["api","authentication","firebase","jwt","middleware"]
created: "2026-01-06T03:33:11.647Z"
updated: "2026-01-06T03:33:11.647Z"
related: ["backend-api","firebase-admin","kinde-jwt","express-server"]
importance: 0.9
---

# Backend API Server Implementation

# Eventos Finais - Backend API Implementation

## Server Architecture

### Express Server Setup
```javascript
// server-firestore.cjs
const express = require('express');
const cors = require('cors');
const admin = require('firebase-admin');
const jwt = require('jsonwebtoken');
const jwksClient = require('jwks-rsa');
const dotenv = require('dotenv');

dotenv.config();
const app = express();
```

### Firebase Admin SDK Initialization
```javascript
const serviceAccount = require('./firebase-service-account.json');
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount)
});
const db = admin.firestore();
```

## Authentication Middleware

### Kinde JWT Validation
```javascript
const authMiddleware = async (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  const client = jwksClient({
    jwksUri: `https://${process.env.VITE_KINDE_DOMAIN}/.well-known/jwks.json`
  });

  const key = await client.getSigningKey();
  const signingKey = key.getPublicKey();
  
  jwt.verify(token, signingKey, (err, decoded) => {
    if (err) {
      return res.status(401).json({ error: 'Invalid token' });
    }
    
    req.user = {
      id: decoded.sub,
      email: decoded.email,
      roles: decoded.roles || [],
      isAdmin: (decoded.roles || []).some(role => 
        role === 'admin' || role.key === 'admin' || role.name === 'Admin'
      )
    };
    
    next();
  });
};
```

### Admin Role Check
```javascript
const adminMiddleware = (req, res, next) => {
  if (!req.user.isAdmin) {
    return res.status(403).json({ error: 'Admin access required' });
  }
  next();
};
```

## API Endpoints

### Chapters Management
```javascript
// GET /api/chapters - Authenticated users
app.get('/api/chapters', authMiddleware, async (req, res) => {
  const snapshot = await db.collection('chapters').orderBy('orderIndex').get();
  const chapters = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  res.json(chapters);
});

// POST /api/chapters - Admin only
app.post('/api/chapters', authMiddleware, adminMiddleware, async (req, res) => {
  // Accept both snake_case and camelCase
  const audioUrl = req.body.audioUrl || req.body.audio_url || '';
  const orderIndex = req.body.orderIndex || req.body.order_index || 0;
  
  const docRef = await db.collection('chapters').add({
    title: req.body.title,
    summary: req.body.summary || '',
    content: req.body.content || '',
    audioUrl,
    orderIndex,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  });
  
  const doc = await docRef.get();
  res.status(201).json({ id: doc.id, ...doc.data() });
});
```

### Chapter Pages Management
```javascript
// GET /api/chapters/:chapterId/pages - Authenticated users
app.get('/api/chapters/:chapterId/pages', authMiddleware, async (req, res) => {
  const snapshot = await db.collection('chapterPages')
    .where('chapterId', '==', req.params.chapterId)
    .orderBy('pageNumber')
    .get();
  
  const pages = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  res.json(pages);
});

// POST /api/chapters/:chapterId/pages - Admin only
app.post('/api/chapters/:chapterId/pages', authMiddleware, adminMiddleware, async (req, res) => {
  const subtitle = req.body.subtitle || '';
  const pageNumber = req.body.pageNumber || req.body.page_number || 1;
  const content = req.body.content || '';
  const orderIndex = req.body.orderIndex || req.body.order_index || 0;
  
  const docRef = await db.collection('chapterPages').add({
    chapterId: req.params.chapterId,
    subtitle,
    pageNumber,
    content,
    orderIndex,
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  });
  
  const doc = await docRef.get();
  res.status(201).json({ id: doc.id, ...doc.data() });
});

// DELETE /api/pages/:pageId - Admin only
app.delete('/api/pages/:pageId', authMiddleware, adminMiddleware, async (req, res) => {
  await db.collection('chapterPages').doc(req.params.pageId).delete();
  res.json({ success: true });
});
```

### User Progress Management
```javascript
// GET /api/progress - Own data only
app.get('/api/progress', authMiddleware, async (req, res) => {
  const snapshot = await db.collection('progress')
    .where('userId', '==', req.user.id)
    .get();
  
  const progress = snapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
  }));
  res.json(progress);
});

// POST /api/progress - Own data only
app.post('/api/progress', authMiddleware, async (req, res) => {
  const { chapterId, completed, currentPage } = req.body;
  
  await db.collection('progress').doc(`${req.user.id}_${chapterId}`).set({
    userId: req.user.id,
    chapterId,
    completed: completed || false,
    currentPage: currentPage || 0,
    updatedAt: admin.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
  
  res.json({ success: true });
});
```

## Error Handling & Logging

### Request Logging
```javascript
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.path}`);
  next();
});
```

### Error Response Format
```javascript
// Consistent error responses
res.status(500).json({ error: 'Failed to create chapter' });
res.status(401).json({ error: 'Invalid token' });
res.status(403).json({ error: 'Admin access required' });
res.status(404).json({ error: 'Chapter not found' });
```

## Field Mapping Strategy

### Backend Accepts Both Formats
```javascript
// Create chapter - accepts both snake_case and camelCase
const audioUrl = req.body.audioUrl || req.body.audio_url || '';
const orderIndex = req.body.orderIndex || req.body.order_index || 0;

// Create page - accepts both formats
const pageNumber = req.body.pageNumber || req.body.page_number || 1;
const orderIndex = req.body.orderIndex || req.body.order_index || 0;
```

### Response Format (camelCase)
```javascript
// Backend always returns camelCase
{
  id: "abc123",
  chapterId: "def456", 
  pageNumber: 1,
  orderIndex: 0,
  createdAt: "...",
  updatedAt: "..."
}
```

## Security Considerations

### JWT Validation
- Uses Kinde JWKS endpoint for public key
- Verifies token signature and expiration
- Extracts user roles from token claims
- Rejects invalid/expired tokens

### Role-Based Access
- Admin endpoints require `adminMiddleware`
- User endpoints only require `authMiddleware`
- Progress endpoints limited to own data
- No direct Firestore access from frontend

### Environment Variables
- Firebase service account key never exposed
- Kinde domain from environment
- No hardcoded credentials

## Performance Optimizations

### Firestore Queries
- Uses indexed queries (orderBy, where)
- Efficient document fetching
- Server timestamps for consistency
- Batch operations where possible

### Response Optimization
- Minimal data transfer
- Consistent response format
- Proper HTTP status codes
- Error handling without stack traces