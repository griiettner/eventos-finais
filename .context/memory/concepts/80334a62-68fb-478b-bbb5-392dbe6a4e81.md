---
id: "80334a62-68fb-478b-bbb5-392dbe6a4e81"
title: "Eventos Finais - Complete Architecture & Integration"
type: "concept"
tags: ["architecture","authentication","database","docker","security"]
created: "2026-01-06T03:34:51.285Z"
updated: "2026-01-06T03:34:51.285Z"
related: ["kinde-auth","firestore-integration","docker-setup","backend-api"]
importance: 1
---

# Eventos Finais - Complete Architecture & Integration

# Eventos Finais - Kinde & Firestore Integration

## Architecture Overview
Eventos Finais is a Progressive Web Application (PWA) for interactive Bible study focused on end-times events. The app serves Portuguese-speaking users with 20 chapters of study content, audio playback, and progress tracking.

## Current Tech Stack
- **Frontend**: React 19, TypeScript, Vite, Framer Motion, TailwindCSS
- **Authentication**: Kinde OAuth (no Firebase Auth)
- **Database**: Firestore (accessed via secure backend API)
- **Backend**: Node.js Express server with Firebase Admin SDK
- **Development**: Docker Compose with hot reload
- **Deployment**: Docker containers

## Key Architecture Decisions

### Authentication Flow
1. User logs in via Kinde OAuth
2. Frontend receives JWT token from Kinde
3. All API calls include Bearer token
4. Backend validates JWT using Kinde JWKS endpoint
5. Backend checks admin role from token claims
6. Backend accesses Firestore with Admin SDK

### Database Access Pattern
- **Frontend**: NEVER directly accesses Firestore
- **Backend**: Only service with Firestore Admin SDK access
- **API**: RESTful endpoints with JWT authentication
- **Security**: Admin-only endpoints protected by role checking

### Docker Development Environment
```yaml
services:
  frontend: # Vite dev server on :5173
    - Hot reload enabled
    - Volume mounts entire project
  api: # Express server on :3001  
    - Validates Kinde JWT
    - Firebase Admin SDK
    - Request logging
```

## Critical Implementation Details

### Backend API Endpoints
- `GET /api/chapters` - Authenticated users
- `POST /api/chapters` - Admin only
- `PUT /api/chapters/:id` - Admin only
- `DELETE /api/chapters/:id` - Admin only
- `GET /api/chapters/:id/pages` - Authenticated
- `POST /api/chapters/:id/pages` - Admin only
- `DELETE /api/pages/:pageId` - Admin only
- `GET /api/progress` - Own data only
- `POST /api/progress` - Own data only

### Field Mapping Strategy
Backend uses camelCase, frontend uses snake_case:
```javascript
// Backend accepts both
audioUrl: req.body.audioUrl || req.body.audio_url
orderIndex: req.body.orderIndex || req.body.order_index
```

### ID Types
- **Firestore**: String IDs (doc.id)
- **Frontend**: String IDs throughout
- **No more parseInt() or number IDs**

### Environment Variables
```bash
# Frontend (VITE_*)
VITE_KINDE_DOMAIN=your-domain.kinde.com
VITE_API_URL=http://localhost:3001

# Backend (reads from .env)
VITE_KINDE_DOMAIN=your-domain.kinde.com
FIREBASE_PROJECT_ID=eventosfinais
```

## Migration History

### From Firebase Auth + Direct Firestore → Kinde + Backend API
1. **Removed Firebase Auth** completely
2. **Created secure backend** with Firebase Admin SDK
3. **Implemented Kinde JWT validation** using jwks-rsa
4. **Updated all frontend services** to use API calls
5. **Removed SQLite** local database entirely
6. **Fixed Docker** to include backend service

### Key Files Changed
- `server-firestore.cjs` - New backend API server
- `src/services/admin-service.ts` - API client with JWT auth
- `src/contexts/AuthContext.tsx` - Kinde-only auth, token getter
- `src/pages/AddEditChapter.tsx` - String IDs, API calls
- `docker-compose.dev.yml` - Frontend + API services

## Common Issues & Solutions

### "ID inválido" Error
- **Cause**: Using parseInt() on string Firestore IDs
- **Fix**: Remove parseInt(), use string IDs throughout

### "Cannot find firebase-service-account.json"
- **Cause**: Missing Firebase Admin SDK service account key
- **Fix**: Download from Firebase Console > Project Settings > Service Accounts

### Field Name Mismatches
- **Cause**: Backend camelCase vs frontend snake_case
- **Fix**: Backend accepts both formats

### Missing Endpoints
- **Cause**: API endpoints not implemented yet
- **Fix**: Add endpoints to server-firestore.cjs

## Development Commands
```bash
# Start development environment
npm run docker:dev:build

# View logs
npm run docker:dev:logs

# Stop containers
npm run docker:dev:down
```

## Security Notes
- Never expose Firebase Admin SDK key to frontend
- Always validate Kinde JWT in backend
- Use admin middleware for protected endpoints
- No open Firestore security rules in production